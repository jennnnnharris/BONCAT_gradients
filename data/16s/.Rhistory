## order asvs table
asvs.t<-asvs.t[order(row.names(asvs.t)),]
## Determine minimum available reads per sample ##
min.s<-min(rowSums(asvs.t))
min.s
### Rarefy to obtain even numbers of reads by sample ###
set.seed(336)
asvs.r<-rrarefy(asvs.t, min.s)
dim(asvs.t)
dim(asvs.r)
###--- recode metadata----- #
metadat<-metadat%>% mutate(Compartment=recode(Fraction, 'Bulk'='Bulk_Soil', 'Rhizo'='Rhizosphere','Endo'='Roots', 'Nod'='Nodule'))
metadat<-metadat[, c(1,3:6)]
metadat<-metadat%>% mutate(Fraction=recode(BONCAT, 'DNA'= 'Total_DNA', 'SYBR'= 'Viable_Cell', 'POS'='Active_Cell', 'ctl'= 'ctl'))
#to make coloring things easier I'm gong to added a combined fractionXboncat column
metadat<-mutate(metadat, compartment_BCAT = paste0(metadat$Fraction, metadat$Compartment))
##------make phyloseq object with rarefied data -------#
asvs.phyloseq<- (asvs.r)
taxon<-taxon[,1:7]
metadat<-as.matrix(metadat)
y<-colnames(asvs.raw)
rownames(metadat) <- y
metadat<-as.data.frame(metadat)
#import it phyloseq
Workshop_ASVS <- otu_table(asvs.phyloseq, taxa_are_rows = FALSE)
Workshop_metadat <- sample_data(metadat)
Workshop_taxo <- tax_table(as.matrix(taxon))
ps <- phyloseq(Workshop_taxo, Workshop_ASVS,Workshop_metadat)
# remove sampled that had less than 50 cells
ps<-subset_samples(ps, SampleID!="C7E-POS_S34")
metadat<-metadat %>% filter(SampleID!="C7E-POS_S34")
# remove chloroplasts
df<-subset_samples(ps, Compartment=="Roots" | Compartment=="Nodule" )
df<-prune_taxa(taxa_sums(df) > 0, df)
remove<-subset_taxa(df, Domain=="Unassigned" |  Phyla=="" | Phyla==" p__"  )
remove
### These 5 ASVS were not mitochondria or chloroplasts, the remain 48 were
kp<-c("a49a51f3a3e3ea140206b10c5665cc13", "55c30bcbeacfedffa7aeb332600548b2" , "cfeae1df224b7e426ea125ab2bb824fc", "b260024f11a7d77d4f03e5ca2e239860", "f5211207035c7ea5b6f2ecfdad3765e1")
badtaxa<-taxa_names(remove)
badtaxa <- badtaxa[!(badtaxa %in% kp)]
length(badtaxa)
########## remove these guys
alltaxa<-taxa_names(ps)
mytaxa <- alltaxa[!(alltaxa %in% badtaxa)]
ps<-prune_taxa(mytaxa, ps )
ps.r<-prune_taxa(taxa_sums(ps) > 0, ps)
ps.r
# check  reads after QC
n<-rowSums(otu_table(ps.r))
# number of ASVS after QC
n<-otu_table(ps)
n<-rowSums(ifelse(n[]>0,1,0))
n
ps1<-subset_samples(ps.r, Compartment != "ctl"& Fraction != "Total_DNA")
ps1<-ps_prune(ps1, min.samples = 3, min.reads = 50)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
# 926 asvs
taxon<- as.data.frame(tax_table(ps1))
df<-as.data.frame(otu_table(ps1))
#remove "other" column where rare taxa went
df<-select(df, -Others)
# remove "other" row where rare taxa went
taxon<-taxon[c(which(row.names(taxon)!="Others")),]
head(df)
#can't use C7 (rep5) because it doesn't have active in the rhizosphere.
#### seperate out each rep
#               abundance_active  abundance_Viable present_in_plant
#otu #1 rep 1
#otu #1 rep 2
metadat$REP
n<-row.names.data.frame(df)
n[grepl("C10" , n)]="1"
n[grepl("C1R" , n)]="2"
n[grepl("C1N" , n)]="2"
n[grepl("C1E" , n)]="2"
n[grepl("C2" , n)]="3"
n[grepl("C5" , n)]="4"
n[grepl("C7" , n)]="5"
df$rep <- n
#rep 1
df1<-filter(df, rep=="1")
unique(row.names(df1))
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
#remove rep
df1<-select(df1, -rep)
# sum by group and make vector
df1<-rowsum(df1, n)
df1<-as.data.frame(t(df1))
head(df1)
# insert column
inplant<-rep(0, length(df1$nodule))
inplant[df1$nodule>50 | df1$roots>50 ]<-"1"
inplant
df1$inplant <- inplant
df1<-df1 %>% select(c(-nodule, -roots))
head(df1)
row.names(df1)<-paste0(row.names(df1), "Rep1")
colnames(df1) <- c("Active", "Viable", "inplant")
rep1<-df1
head(rep1)
##rep 2
df1<-filter(df, rep=="2")
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
#remove rep
df1<-select(df1, -rep)
# sum by group and make vector
df1<-rowsum(df1, n)
df1<-as.data.frame(t(df1))
# insert column
inplant<-rep(0, length(df1$nodule))
inplant[df1$nodule>50 | df1$roots>50 ]<-"1"
df1$inplant <- inplant
df1<-df1 %>% select(c(-nodule, -roots))
row.names(df1)<-paste0(row.names(df1), "Rep2")
colnames(df1) <- c("Active", "Viable", "inplant")
head(df1)
rep2<-df1
##rep 3
df1<-filter(df, rep=="3")
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
#remove rep
df1<-select(df1, -rep)
# sum by group and make vector
df1<-rowsum(df1, n)
df1<-as.data.frame(t(df1))
# insert column
inplant<-rep(0, length(df1$nodule))
inplant[df1$nodule>50 | df1$roots>50 ]<-"1"
df1$inplant <- inplant
df1<-df1 %>% select(c(-nodule, -roots))
row.names(df1)<-paste0(row.names(df1), "Rep3")
colnames(df1) <- c("Active", "Viable", "inplant")
head(df1)
rep3<-df1
##rep 4
df1<-filter(df, rep=="4")
unique(row.names(df1))
#determine ASVs in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
#remove rep
df1<-select(df1, -rep)
# sum by group and make vector
df1<-rowsum(df1, n)
df1<-as.data.frame(t(df1))
head(df1)
# insert column
inplant<-rep(0, length(df1$nodule))
inplant[df1$nodule>50 | df1$roots>50 ]<-"1"
df1$inplant <- inplant
df1<-df1 %>% select(c(-nodule, -roots))
row.names(df1)<-paste0(row.names(df1), "Rep4")
head(df1)
colnames(df1) <- c("Viable", "Active", "inplant")
head(df1)
rep4<-df1
head(rep4)
### put them together
df1<-rbind(rep1, rep2)
df1<-rbind(df1, rep3)
df1<-rbind(df1, rep4)
df1$inplant <- as.numeric(df1$inplant)
colnames(df1)
dim(df1)
head(df1)
# Models:
fit <- glm(df1$inplant ~ df1$Viable+ df1$Active + df1$Active*df1$Viable, family = binomial)
summary(fit)
head(df1)
ps1
row.names(as.data.frame(otu_table(ps1)))
col.names(as.data.frame(otu_table(ps1)))
col_names(as.data.frame(otu_table(ps1)))
colnames(as.data.frame(otu_table(ps1)))
df<-as.data.frame(otu_table(ps1))
#remove "other" column where rare taxa went
df<-select(df, -Others)
df
colnames(df)
n<-colnames(df)
#
ps1<-subset_samples(ps.r, Compartment != "ctl")
ps1<-prune_taxa(taxa_names(ps1)=n, ps1 )
ps1<-prune_taxa(taxa_names(ps1)==n, ps1 )
#
ps1<-subset_samples(ps.r, Compartment != "ctl")
ps1<-prune_taxa(taxa_names(ps1)==n, ps1 )
ps1
#
ps1<-subset_samples(ps.r, Compartment != "ctl")
ps1
ps1<-prune_taxa(taxa_names(ps1)==n, ps1 )
#
ps1<-subset_samples(ps.r, Compartment != "ctl")
ps1<-prune_taxa(taxa_names(ps1)==n, ps1 )
ps1
###BINOMIAL model####
# rrarefied data to be able to compare samples
###make data frame##
ps1<-subset_samples(ps.r, Compartment != "ctl"& Fraction != "Total_DNA")
ps1<-ps_prune(ps1, min.samples = 3, min.reads = 50)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
#### grab taxa names
df<-as.data.frame(otu_table(ps1))
#remove "other" column where rare taxa went
df<-select(df, -Others)
n<-colnames(df)
n
#
ps1<-subset_samples(ps.r, Compartment != "ctl")
ps1
prune_taxa(n, ps1 )
ps1<-prune_taxa(n, ps1 )
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
as.data.frame(tax_table(ps1))
taxon<-as.data.frame(tax_table(ps1))
###BINOMIAL model####
# rrarefied data to be able to compare samples
###make data frame##
ps1<-subset_samples(ps.r, Compartment != "ctl"& Fraction != "Total_DNA")
ps1<-ps_prune(ps1, min.samples = 3, min.reads = 50)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
#### grab taxa names
df<-as.data.frame(otu_table(ps1))
#remove "other" column where rare taxa went
df<-select(df, -Others)
n<-colnames(df)
n
#
ps1<-subset_samples(ps.r, Compartment != "ctl")
ps1<-prune_taxa(n, ps1 )
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
df<-as.data.frame(otu_table(ps1))
taxon<-as.data.frame(tax_table(ps1))
n<-row.names.data.frame(df)
n[grepl("C10" , n)]="1"
n[grepl("C1R" , n)]="2"
n[grepl("C1N" , n)]="2"
n[grepl("C1E" , n)]="2"
n[grepl("C2" , n)]="3"
n[grepl("C5" , n)]="4"
n[grepl("C7" , n)]="5"
df$rep <- n
#rep 1
df1<-filter(df, rep=="1")
unique(row.names(df1))
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
#remove rep
df1<-select(df1, -rep)
# sum by group and make vector
df1<-rowsum(df1, n)
df1<-as.data.frame(t(df1))
head(df1)
# insert column
inplant<-rep(0, length(df1$nodule))
inplant[df1$nodule>50 | df1$roots>50 ]<-"1"
inplant
df1$inplant <- inplant
df1<-df1 %>% select(c(-nodule, -roots))
head(df1)
head(df1)
row.names(df1)<-paste0(row.names(df1), "Rep1")
colnames(df1) <- c("Active", "Viable", "inplant")
rep1<-df1
head(rep1)
##rep 2
df1<-filter(df, rep=="2")
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
#remove rep
df1<-select(df1, -rep)
# sum by group and make vector
df1<-rowsum(df1, n)
df1<-as.data.frame(t(df1))
# insert column
inplant<-rep(0, length(df1$nodule))
inplant[df1$nodule>50 | df1$roots>50 ]<-"1"
df1$inplant <- inplant
df1<-df1 %>% select(c(-nodule, -roots))
df1
ps1
df<-as.data.frame(otu_table(ps1))
taxon<-as.data.frame(tax_table(ps1))
#can't use C7 (rep5) because it doesn't have active in the rhizosphere.
#### seperate out each rep
#               abundance_active  abundance_Viable present_in_plant
#otu #1 rep 1
#otu #1 rep 2
metadat$REP
n<-row.names.data.frame(df)
n[grepl("C10" , n)]="1"
n[grepl("C1R" , n)]="2"
n[grepl("C1N" , n)]="2"
n[grepl("C1E" , n)]="2"
n[grepl("C2" , n)]="3"
n[grepl("C5" , n)]="4"
n[grepl("C7" , n)]="5"
df$rep <- n
#rep 1
df1<-filter(df, rep=="1")
df1
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
#remove rep
df1<-select(df1, -rep)
df1
# sum by group and make vector
df1<-rowsum(df1, n)
df1
df1<-as.data.frame(t(df1))
head(df1)
#rep 1
df1<-filter(df, rep=="1")
unique(row.names(df1))
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n[grepl("N." , n)]="nodule"
n[grepl("E." , n)]="roots"
n
#rep 1
df1<-filter(df, rep=="1")
unique(row.names(df1))
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n
n
#
ps1<-subset_samples(ps.r, Compartment != "ctl", Compartment != "Bulk_Soil")
###BINOMIAL model####
# rrarefied data to be able to compare samples
###make data frame##
ps1<-subset_samples(ps.r, Compartment != "ctl"& Fraction != "Total_DNA")
ps1<-ps_prune(ps1, min.samples = 3, min.reads = 50)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
#### grab taxa names
df<-as.data.frame(otu_table(ps1))
#remove "other" column where rare taxa went
df<-select(df, -Others)
n<-colnames(df)
n
#
ps1<-subset_samples(ps.r, Compartment != "ctl", Compartment != "Bulk_Soil")
ps1<-prune_taxa(n, ps1 )
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
df<-as.data.frame(otu_table(ps1))
taxon<-as.data.frame(tax_table(ps1))
df
#can't use C7 (rep5) because it doesn't have active in the rhizosphere.
#### seperate out each rep
#               abundance_active  abundance_Viable present_in_plant
#otu #1 rep 1
#otu #1 rep 2
metadat$REP
n<-row.names.data.frame(df)
n
#
ps1<-subset_samples(ps.r, Compartment != "ctl", Compartment != "Bulk_Soil")
ps1<-prune_taxa(n, ps1 )
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
sample_data(ps1)
#
ps1<-subset_samples(ps.r, Compartment != "ctl" &Compartment != "Bulk_Soil")
ps1<-prune_taxa(n, ps1 )
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
#
ps1<-subset_samples(ps.r, Compartment != "ctl" &Compartment != "Bulk_Soil")
#
ps1<-subset_samples(ps.r, Compartment != "ctl" & Compartment != "Bulk_Soil")
ps1
ps1<-prune_taxa(n, ps1 )
ps1
ps1<-prune_taxa(n, ps1)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
ps1<-prune_taxa(-n, ps1)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
###BINOMIAL model####
# rrarefied data to be able to compare samples
###make data frame##
ps1<-subset_samples(ps.r, Compartment != "ctl"& Fraction != "Total_DNA")
ps1<-ps_prune(ps1, min.samples = 3, min.reads = 50)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
#### grab taxa names
df<-as.data.frame(otu_table(ps1))
#remove "other" column where rare taxa went
df<-select(df, -Others)
n<-colnames(df)
n
length(n)
#
ps1<-subset_samples(ps.r, Compartment != "ctl" & Compartment != "Bulk_Soil")
ps1
#
ps1<-subset_samples(ps.r, Fraction != "ctl" & Compartment != "Bulk_Soil")
ps1
prune_taxa(n, ps1)
ps1<-prune_taxa(n, ps1)
ps1
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
df<-as.data.frame(otu_table(ps1))
taxon<-as.data.frame(tax_table(ps1))
sample_data(ps1)
#can't use C7 (rep5) because it doesn't have active in the rhizosphere.
#### seperate out each rep
#               abundance_active  abundance_Viable present_in_plant
#otu #1 rep 1
#otu #1 rep 2
metadat$REP
n
n
n<-row.names.data.frame(df)
n
#
ps1<-subset_samples(ps.r, Fraction != "ctl" & Compartment != "Bulk_Soil")
ps1<-prune_taxa(n, ps1)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
sampledata(ps1)
sample_data(ps1)
###BINOMIAL model####
# rrarefied data to be able to compare samples
###make data frame##
ps1<-subset_samples(ps.r, Compartment != "ctl"& Fraction != "Total_DNA")
ps1<-ps_prune(ps1, min.samples = 3, min.reads = 50)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
#### grab taxa names
df<-as.data.frame(otu_table(ps1))
#remove "other" column where rare taxa went
df<-select(df, -Others)
n<-colnames(df)
n
length(n)
#
ps1<-subset_samples(ps.r, Compartment!="ctl" & Compartment != "Bulk_Soil")
ps1<-prune_taxa(n, ps1)
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
ps1
df<-as.data.frame(otu_table(ps1))
taxon<-as.data.frame(tax_table(ps1))
#can't use C7 (rep5) because it doesn't have active in the rhizosphere.
#### seperate out each rep
#               abundance_active  abundance_Viable present_in_plant
#otu #1 rep 1
#otu #1 rep 2
metadat$REP
n
#can't use C7 (rep5) because it doesn't have active in the rhizosphere.
#### seperate out each rep
#               abundance_active  abundance_Viable present_in_plant
#otu #1 rep 1
#otu #1 rep 2
metadat$REP
n<-row.names.data.frame(df)
n
n[grepl("C10" , n)]="1"
n[grepl("C1R" , n)]="2"
n[grepl("C1N" , n)]="2"
n[grepl("C1E" , n)]="2"
n[grepl("C2" , n)]="3"
n[grepl("C5" , n)]="4"
n[grepl("C7" , n)]="5"
df$rep <- n
df$rep
#rep 1
df1<-filter(df, rep=="1")
unique(row.names(df1))
#find out if somehting is in plant
n<-row.names.data.frame(df1)
n
n
n[grepl("10N." , n)]="nodule"
n[grepl("10E." , n)]="roots"
n
#remove rep
df1<-select(df1, -rep)
# sum by group and make vector
df1<-rowsum(df1, n)
df1<-as.data.frame(t(df1))
head(df1)
# insert column
inplant<-rep(0, length(df1$nodule))
inplant[df1$nodule>50 | df1$roots>50 ]<-"1"
inplant
df1$inplant <- inplant
df1<-df1 %>% select(c(-nodule, -roots))
head(df1)
colnames(df1) <- c("DNA", "Active", "Viable", "inplant")
rep1<-df1
head(rep1)
head(rep1)
