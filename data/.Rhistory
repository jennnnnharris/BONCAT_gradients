rm(list=ls())
#if (!require("BiocManager", quietly = TRUE))
# install.packages("BiocManager")
#BiocManager::install("phyloseq")
BiocManager::install("Heatplus")
library(gplots)
library(ggplot2)
library(vegan)
library(plyr)
library(RColorBrewer)
library(reshape2)
library(scales)
library(data.table)
library(dplyr)
library(phyloseq)
library(DT)
library(Heatplus)
library(viridis)
library(hrbrthemes)
library(ade4)
## Set the working directory; modify to your own ###
setwd("C:/Users/Jenn/OneDrive - The Pennsylvania State University/Documents/Github/BONCAT_gradients/data")
### Import Data ###
taxon <- read.table("16s/taxonomy.txt", sep="\t", header=T, row.names=1)
otus.raw <- read.table("16s/feature-table.tsv", sep="\t", header=T, row.names = 1 )
metadat <- read.delim("16s/metadata.txt", sep="\t", header = T, check.names=FALSE)
## Transpose OTU table ##
otus.t <- t(otus.raw)
## order metadata
metadat<-metadat[order(metadat$SampleID),]
## order otu table
otus.t<-otus.t[order(row.names(otus.t)),]
## Determine minimum available reads per sample ##
min(rowSums(otus.t))
### Rarefy to obtain even numbers of reads by sample ###
set.seed(336)
otus.r<-rrarefy(otus.t, 41610)
######--- recode metadata----- ########
metadat<-metadat%>% mutate(Compartment=recode(Fraction, 'Bulk'='Bulk_Soil', 'Rhizo'='Rhizosphere','Endo'='Roots', 'Nod'='Nodule'))
metadat<-metadat[, c(1,3:6)]
metadat<-metadat%>% mutate(Fraction=recode(BONCAT, 'DNA'= 'Total_DNA', 'SYBR'= 'Total_Cells', 'POS'='BONCAT_Active', 'ctl'= 'ctl'))
#to make coloring things easier I'm gong to added a combined fractionXboncat column
metadat<-mutate(metadat, compartment_BCAT = paste0(metadat$Compartment, metadat$Fraction))
otus.phyloseq<- (otus.r)
taxon<-taxon[,1:7]
metadat<-as.matrix(metadat)
y<-colnames(otus.raw)
rownames(metadat) <- y
metadat<-as.data.frame(metadat)
#import it phyloseq
Workshop_OTU <- otu_table(otus.phyloseq, taxa_are_rows = FALSE)
Workshop_metadat <- sample_data(metadat)
Workshop_taxo <- tax_table(as.matrix(taxon))
ps <- phyloseq(Workshop_taxo, Workshop_OTU,Workshop_metadat)
#test it worked
sample_names(ps)
print(ps)
# remove chloroplast DNA
ps<-subset_taxa(ps, Class!=" Chloroplast")
ps<-subset_taxa(ps, Genus!=" Mitochondria")
ps<-subset_taxa(ps, Genus!=" Chloroplast")
# get rid of taxa that aren; in any samples
ps<-prune_taxa(taxa_sums(ps) > 0, ps)
any(taxa_sums(ps) == 0)
ps
otus<-as.data.frame(t(as.data.frame(otu_table(ps))))
taxon<-as.data.frame(tax_table(ps))
#################------ calculating inactive fraction---------------####
#### remove taxa from bulk soil
ps1<- subset_samples(ps,Fraction !="Total_DNA" )
ps1<-prune_taxa(taxa_sums(ps1) > 0, ps1)
any(taxa_sums(ps1) == 0)
ps1
# subset total cell and active fraction
ps.Total<- subset_samples(ps1,Fraction =="Total_Cells" )
otu_total<-as.data.frame(t(as.data.frame(otu_table(ps.Total))))
otu_total<-select(otu_total, -C7R.SYBR_S19)
ps.Active<- subset_samples(ps1,Fraction =="BONCAT_Active" )
otu_active<-as.data.frame(t(as.data.frame(otu_table(ps.Active))))
## missing some sample from sybr for C10 E and C5 N
## so i think I'll just remove those ones and won't have a value for inactive for those samples
otu_active<-select(otu_active, -C10E.POS_S60, -C5N.POS_S63)
#subset
#Inactive<- total- active
otu_inactive<-otu_total-otu_active
otu_inactive[otu_inactive<0]<-0
otu_inactive
#length 7185
#       C10N.SYBR_S26 C10R.SYBR_S20 C1E.SYBR_S21 C1N.SYBR_S13
# taxa1  0              47          0            0
# taxa2  0              0           0            0
# taxa3  0              22          0            0
#
#
colnames(otu_inactive)
# change colnames
n<-c("C10N.inactive", "C10R.inactive", "C1E.inactive"  ,"C1N.inactive" , "C1R.inactive", "C2E.inactive" , "C2N.inactive"  ,"C2R.inactive" , "C5E.inactive",
"C5R.inactive",  "C7E.inactive",  "C7N.inactive" )
colnames(otu_inactive)<- n
# append the original dataset by adding the inactive taxa
#make an asvs col to join by
y<-row.names(otus)
otus<-mutate(otus, asvs= y)
y<-row.names(otu_inactive)
otu_inactive<-mutate(otu_inactive, asvs= y)
# join data frames
otus<-full_join(otu_inactive, otus)
# as row names from the asvs bit
y<-otus$asvs
row.names(otus) <- y
otus<-select(otus, -asvs)
otus
# make all the asvs that are NA in the inactive fraction zeros
otus[is.na(otus)] <- 0
#just checking the row names and col names look right
rownames(otus)
colnames(otus)
setwd("C:/Users/Jenn/OneDrive - The Pennsylvania State University/Documents/Github/BONCAT_gradients/data")
metadat <- read.delim("16s/metadata_w_inactive.txt", sep="\t", header = T, check.names=FALSE)
metadat<-metadat%>% mutate(Compartment=recode(Fraction, 'Bulk'='Bulk_Soil', 'Rhizo'='Rhizosphere','Endo'='Roots', 'Nod'='Nodule', 'ctl'='ctl'))
metadat<-metadat[, c(1,3:6)]
metadat<-metadat%>% mutate(Fraction=recode(BONCAT, 'DNA'= 'Total_DNA', 'SYBR'= 'Total_Cells', 'POS'='BONCAT_Active', 'ctl'= 'ctl'))
#to make coloring things easier I'm gong to added a combined fractionXboncat column no sure if i need this
metadat<-mutate(metadat, compartment_BCAT = paste0(metadat$Compartment, metadat$Fraction))
metadat<-select(metadat, -BONCAT)
## order metadata
metadat<-metadat[order(metadat$SampleID),]
metadat
## order otu table
otus<-otus[, order(colnames(otus))]
## Convert OTU numbers to percentages ##
otus.perc<-otus/rowSums(otus)*100
otus.phyloseq<- t(otus)
#head(otus.phyloseq)
metadat<-as.matrix(metadat)
y<-colnames(otus)
rownames(metadat) <- y
metadat<-as.data.frame(metadat)
#import it phyloseq
Workshop_OTU <- otu_table(as.matrix(otus.phyloseq), taxa_are_rows = FALSE)
Workshop_metadat <- sample_data(metadat)
Workshop_taxo <- tax_table(as.matrix(taxon)) # this taxon file is from the prev phyloseq object length = 14833
ps <- phyloseq(Workshop_taxo, Workshop_OTU,Workshop_metadat)
#test it worked
sample_names(ps)
print(ps)
# set wd for figures
setwd("C:/Users/Jenn/The Pennsylvania State University/Burghardt, Liana T - Burghardt Lab Shared Folder/Projects/BONCAT/Data/")
# diversity
rich<-estimate_richness(ps, measures = c("Observed", "Shannon", "Simpson", "InvSimpson" ))
svg(file="figures/16s/diversity.svg",width = 10, height=4 )
#windows()
plot_richness(ps, "Fraction", measures = c("Observed","Shannon", "Simpson", "InvSimpson")) +
geom_boxplot(aes(fill = "Fraction")) + scale_fill_manual(values = c("#CBD588", "#5F7FC7", "orange","#DA5724", "#508578"))
dev.off()
#windows()
plot_richness(ps, "Fraction", measures = c("Observed","Shannon", "Simpson", "InvSimpson")) +
geom_boxplot(aes(fill = "Fraction")) + scale_fill_manual(values = c("#CBD588", "#5F7FC7", "orange","#DA5724", "#508578"))
# diversity of active microbes in each fraction
rich<-cbind(rich, metadat)
rich<-as.data.frame(rich)
colnames(rich)
rich$Compartment<-factor(rich$Compartment, levels = c("Bulk_Soil", "Rhizosphere", "Roots", "Nodule"))
reorder(compartment_BCAT, -Observed)
windows()
rich %>%
filter(Plant!="NOPLANT", Fraction!="Inactive", Fraction!="BONCAT_Active")%>%
ggplot(aes(x=reorder(compartment_BCAT,-Observed), y=Observed, fill = Fraction))+
geom_boxplot() +
scale_fill_manual(values = c("grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
theme(axis.text.x = element_text(angle=60, hjust=1))+
ylab("Number of ASVs")+
xlab("Compartment")
rich
rich %>%
filter(Plant!="NOPLANT", Fraction!="Inactive", Fraction!="BONCAT_Active")%>%
ggplot(aes(x=reorder(compartment_BCAT,-Observed), y=Shannon, fill = Fraction))+
geom_boxplot() +
scale_fill_manual(values = c("grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
theme(axis.text.x = element_text(angle=60, hjust=1))+
#ylab()+
xlab("Compartment")
rich<- rich %>%  filter(Plant!="NOPLANT", Fraction!="Inactive")
rich$compartment_BCAT <-factor(rich$compartment_BCAT, levels = c("Bulk_SoilTotal_DNA", "RhizosphereTotal_DNA", "RhizosphereTotal_Cells", "RhizosphereBONCAT_Active",
"RootsTotal_Cells"   ,  "RootsBONCAT_Active" , "NoduleTotal_Cells" ,  "NoduleBONCAT_Active" ))
windows()
rich %>%
filter(Plant!="NOPLANT", Fraction!="Inactive")%>%
ggplot(aes(x=compartment_BCAT, y=Observed, fill = Fraction, col= Fraction))+
geom_boxplot() +
scale_colour_manual(values = c( "orange",  "black", "black"))+
scale_fill_manual( values = c("gold", "grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
theme(axis.text.x = element_text(angle=60, hjust=1))+
ylab("Number of ASVs")+
xlab("Compartment")
rich %>%
filter(Plant!="NOPLANT", Fraction!="Inactive")%>%
ggplot(aes(x=compartment_BCAT, y=Shannon, fill = Fraction, col= Fraction))+
geom_boxplot() +
scale_colour_manual(values = c( "orange",  "black", "black"))+
scale_fill_manual( values = c("gold", "grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
theme(axis.text.x = element_text(angle=60, hjust=1))+
ylab("Number of ASVs")+
xlab("Compartment")
ws()
rich
rich %>%
filter(Plant!="NOPLANT", Fraction!="Inactive")%>%
ggplot(aes(x=compartment_BCAT, y=Simpson, fill = Fraction, col= Fraction))+
geom_boxplot() +
scale_colour_manual(values = c( "orange",  "black", "black"))+
scale_fill_manual( values = c("gold", "grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
theme(axis.text.x = element_text(angle=60, hjust=1))+
ylab("Number of ASVs")+
xlab("Compartment")
rich %>%
filter(Plant!="NOPLANT", Fraction!="Inactive")%>%
ggplot(aes(x=compartment_BCAT, y=Simpson, fill = Fraction, col= Fraction))+
geom_boxplot() +
scale_colour_manual(values = c( "orange",  "black", "black"))+
scale_fill_manual( values = c("gold", "grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
theme(axis.text.x = element_text(angle=60, hjust=1))+
#ylab("Number of ASVs")+
xlab("Compartment")
rich %>%
filter(Plant!="NOPLANT", Fraction!="Inactive")%>%
ggplot(aes(x=compartment_BCAT, y=InvSimpson, fill = Fraction, col= Fraction))+
geom_boxplot() +
scale_colour_manual(values = c( "orange",  "black", "black"))+
scale_fill_manual( values = c("gold", "grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
theme(axis.text.x = element_text(angle=60, hjust=1))+
#ylab("Number of ASVs")+
xlab("Compartment")
rich %>%
filter(BONCAT!="DNA", Fraction!="ctl", Compartment== "Roots", REP!=1)%>%
ggplot(aes(x=Fraction, y=Observed, col=REP))+
#geom_boxplot() +
#geom_line( x=Fraction, y=Observed, col= rep )
#scale_fill_manual(values = c("grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
ylab("Number of ASVs")+
theme_bw()
root_total<-subset_samples(ps, compartment_BCAT=="RootsTotal_Cells")
root_total<-prune_taxa(taxa_sums(root_total) > 0, root_total)
any(taxa_sums(root_total) == 0)
root_total
tax_table(root_total)
total<-as.data.table(otu_table(root_total))
t(total)
root_active<-subset_samples(ps, compartment_BCAT=="RootsBONCAT_Active")
root_active<-prune_taxa(taxa_sums(root_active) > 0, root_active)
any(taxa_sums(root) == 0)
tt<-as.data.table(tax_table(root_active))
ot<-as.data.table(otu_table(root_active))
t(ot)
root_active<-cbind(ot,tt)
root_active
root_total<-subset_samples(ps, compartment_BCAT=="RootsTotal_Cells")
rich %>%
filter(BONCAT!="DNA", Fraction!="ctl", Compartment== "Roots", REP!=1)%>%
ggplot(aes(x=Fraction, y=Observed, col=REP))+
#geom_boxplot() +
#geom_line( x=Fraction, y=Observed, col= rep )
#scale_fill_manual(values = c("grey27", "lightgrey"))+
geom_jitter(width = .1, size=1 )+
ylab("Number of ASVs")+
theme_bw()
root_total<-subset_samples(ps, compartment_BCAT=="RootsTotal_Cells")
root_total<-subset_samples(ps, compartment_BCAT=="RootsTotal_Cells")
root_total<-prune_taxa(taxa_sums(root_total) > 0, root_total)
any(taxa_sums(root_total) == 0)
root_total
root_active<-subset_samples(ps, compartment_BCAT=="RootsBONCAT_Active")
root_active<-prune_taxa(taxa_sums(root_active) > 0, root_active)
any(taxa_sums(root) == 0)
root_active<-subset_samples(ps, compartment_BCAT=="RootsBONCAT_Active")
root_active<-prune_taxa(taxa_sums(root_active) > 0, root_active)
any(taxa_sums(root) == 0)
any(taxa_sums(root_active) == 0)
tt<-as.data.table(tax_table(root_active))
ot<-as.data.table(otu_table(root_active))
t(ot)
root_active
tt<-as.data.table(tax_table(root_active))
tt
ot<-as.data.table(otu_table(root_active))
ot
t(ot)
ot<-t(ot)
root_active<-cbind(ot,tt)
root_active
View(root_active)
rowsum(root_active)
rowSums(root_active)
root_active[,5]
root_active[,1:5]
rowSums(root_active[,1:5])
sum<-rowSums(root_active[,1:5])
mutate(root_active, sum= sum)
root_active<-mutate(root_active, sum= sum)
t(total)
tt<-as.data.table(tax_table(root_total))
ot<-as.data.table(otu_table(root_total))
tt<-as.data.table(tax_table(root_total))
ot<-t(ot)
total<-cbind(ot,tt)
ot<-as.data.table(otu_table(root_total))
tt<-as.data.table(tax_table(root_total))
root_total<-subset_samples(ps, compartment_BCAT=="RootsTotal_Cells")
root_total<-prune_taxa(taxa_sums(root_total) > 0, root_total)
any(taxa_sums(root_total) == 0)
root_total
tax_table(root_total)
ot<-as.data.table(otu_table(root_total))
tt<-as.data.table(tax_table(root_total))
ot<-t(ot)
total<-cbind(ot,tt)
total
sum<-rowSums(total[,1:4])
total<-mutate(total, sum= sum)
View(total)
hist(total$sum)
root_active$sum
hist(root_active$sum)
window()
hist(total$sum)
window("total")
hist(total$sum)
hist(root_active$sum)
window()
windows()
hist(root_active$sum)
hist(total$sum)
filter(root_total, sum>1)
filter(Total, sum>1)
filter(total, sum>1)
dim(filter(total, sum>1))
dim(filter(root_active, sum>1))
dim(filter(root_active, sum>2))
dim(filter(root_active, sum>3))
dim(filter(root_active, sum>4))
dim(filter(root_active, sum>5))
dim(filter(total, sum>5))
dim(filter(total, sum>1))
dim(filter(root_active, sum>``))
dim(filter(root_active, sum>1))
#check n taxa
rank_names(ps)
#interacting with phyloseq object
sample_variables(ps)
length(sample_variables(ps))
#what phyla are here?
rank_names(ps)
get_taxa_unique(ps, "Phyla")
#how many of each taxa?
taxa_sums(ps)
# Are some taxa rare?
OTUabundance = as.numeric(taxa_sums(ps))
ASV = taxa_names(ps)
d1<-as.data.frame(OTUabundance)
d1<-cbind(d1, ASV)
ggplot(d1, aes(OTUabundance)) +
geom_histogram() +
ggtitle("Histogram of Total Counts") +
xlim(0, 20000) + ylim (0,50) + theme_bw()
#select most abundant taxa
topN = 20
source("C:/Users/Jenn/OneDrive - The Pennsylvania State University/Documents/Github/BONCAT_gradients/analysis/16s_analysis.r", echo=TRUE)
